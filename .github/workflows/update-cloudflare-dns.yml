name: Update Cloudflare DNS

on:
  workflow_call:
    inputs:
      cname:
        description: 'CNAME target to point the domain to'
        required: true
        type: string
      domain:
        description: 'Domain name for DNS updates'
        required: false
        type: string
      subdomain:
        description: 'Subdomain for DNS updates'
        required: false
        type: string
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
    outputs:
      deployment_url:
        description: 'Final deployment URL (custom domain or original URL)'
        value: ${{ jobs.update-dns.outputs.deployment_url }}
  workflow_dispatch:
    inputs:
      cname:
        description: 'CNAME target to point the domain to'
        required: true
        type: string
      domain:
        description: 'Domain name for DNS updates'
        required: false
        type: string
      subdomain:
        description: 'Subdomain for DNS updates'
        required: false
        type: string

jobs:
  update-dns:
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.dns-update.outputs.deployment_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Cloudflare DNS
        id: dns-update
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || env.CLOUDFLARE_API_TOKEN }}
          DOMAIN: ${{ inputs.domain }}
          SUBDOMAIN: ${{ inputs.subdomain }}
          RECORD_TYPE: "CNAME"
          CNAME_TARGET: ${{ inputs.cname }}
          TTL: "300"
        run: |
          # Use CNAME target as record value
          RECORD_VALUE="$CNAME_TARGET"
          
          # Skip DNS update if DOMAIN is not set
          if [ -z "$DOMAIN" ]; then
            echo "â„¹ï¸ DOMAINì´ ì„¤ì •ë˜ì§€ ì•Šì•„ DNS ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "deployment_url=https://$CNAME_TARGET" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine full domain name based on branch and subdomain
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          if [ "$BRANCH_NAME" = "main" ]; then
            if [ -n "$SUBDOMAIN" ]; then
              FULL_DOMAIN="${SUBDOMAIN}.${DOMAIN}"
            else
              FULL_DOMAIN="$DOMAIN"
            fi
          else
            if [ -n "$SUBDOMAIN" ]; then
              FULL_DOMAIN="${BRANCH_NAME}-${SUBDOMAIN}.${DOMAIN}"
            else
              FULL_DOMAIN="${BRANCH_NAME}.${DOMAIN}"
            fi
          fi

          echo "ðŸŒ DNS ì—…ë°ì´íŠ¸ ì‹œìž‘: $FULL_DOMAIN â†’ $RECORD_VALUE"

          # Get Zone ID with debugging
          echo "ðŸ” ë„ë©”ì¸ ì¡°íšŒ ì¤‘: $DOMAIN"
          ZONE_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$DOMAIN" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")
          
          echo "ðŸ“‹ API ì‘ë‹µ:"
          echo "$ZONE_RESPONSE" | jq '.'
          
          ZONE_ID=$(echo "$ZONE_RESPONSE" | jq -r '.result[0].id // empty')
          
          if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ]; then
            echo "âŒ ë„ë©”ì¸ $DOMAINì˜ Zone IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ðŸ’¡ ê°€ëŠ¥í•œ ì›ì¸:"
            echo "  - ë„ë©”ì¸ì´ Cloudflareì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŒ"
            echo "  - API í† í°ì— Zone:Read ê¶Œí•œì´ ì—†ìŒ"
            echo "  - ë„ë©”ì¸ ì´ë¦„ì´ ì •í™•í•˜ì§€ ì•ŠìŒ"
            echo ""
            echo "âš¡ DNS ì—…ë°ì´íŠ¸ ì‹¤íŒ¨, ì›ë³¸ URL ì‚¬ìš©:"
            echo "deployment_url=https://$CNAME_TARGET" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ðŸ“ Zone ID: $ZONE_ID"

          # Check if record exists
          RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$FULL_DOMAIN&type=$RECORD_TYPE" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[0].id // empty')

          if [ -n "$RECORD_ID" ] && [ "$RECORD_ID" != "null" ]; then
            echo "ðŸ“ ê¸°ì¡´ DNS ë ˆì½”ë“œ ë°œê²¬, ì—…ë°ì´íŠ¸ ì¤‘... (ID: $RECORD_ID)"
            UPDATE_RESPONSE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{
                "type": "'$RECORD_TYPE'",
                "name": "'$FULL_DOMAIN'",
                "content": "'$RECORD_VALUE'",
                "ttl": '$TTL',
                "proxied": true
              }')
            echo "ðŸ” ì—…ë°ì´íŠ¸ ì‘ë‹µ: $UPDATE_RESPONSE"
            
            # Check if update was successful
            if echo "$UPDATE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "âœ… DNS ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
            else
              echo "âŒ DNS ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
              echo "$UPDATE_RESPONSE" | jq '.errors[]?' || echo "ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨"
            fi
          else
            echo "âž• ìƒˆ DNS ë ˆì½”ë“œ ìƒì„± ì¤‘..."
            CREATE_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{
                "type": "'$RECORD_TYPE'",
                "name": "'$FULL_DOMAIN'",
                "content": "'$RECORD_VALUE'",
                "ttl": '$TTL',
                "proxied": true
              }')
            echo "ðŸ” ìƒì„± ì‘ë‹µ: $CREATE_RESPONSE"
            
            # Check if creation was successful
            if echo "$CREATE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "âœ… DNS ë ˆì½”ë“œ ìƒì„± ì„±ê³µ!"
            else
              echo "âŒ DNS ë ˆì½”ë“œ ìƒì„± ì‹¤íŒ¨!"
              echo "$CREATE_RESPONSE" | jq '.errors[]?' || echo "ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨"
            fi
          fi

          # DNS ì—…ë°ì´íŠ¸ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë°°í¬ URL í‘œì‹œ
          FINAL_DEPLOYMENT_URL="https://$FULL_DOMAIN"
          
          echo "ðŸš€ ë°°í¬ ì™„ë£Œ: $FINAL_DEPLOYMENT_URL"
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì „ì²´ URL: \`$FINAL_DEPLOYMENT_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "deployment_url=$FINAL_DEPLOYMENT_URL" >> $GITHUB_OUTPUT