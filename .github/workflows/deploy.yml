name: Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  semantic-release:
    name: Create Release Notes
    uses: ./.github/workflows/semantic-release.yml
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-lambda:
    name: Deploy to AWS Lambda & S3
    needs: semantic-release
    if: always()
    uses: ./.github/workflows/deploy-rr7-lambda-s3.yml
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

  update-dns:
    name: Update Cloudflare DNS
    needs: deploy-lambda
    if: needs.deploy-lambda.result == 'success'
    uses: ./.github/workflows/update-cloudflare-dns.yml
    with:
      cname: ${{ needs.deploy-lambda.outputs.cname }}
      domain: ${{ vars.DOMAIN }}
      subdomain: ${{ vars.SUBDOMAIN }}
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  notify-telegram:
    name: Notify Deployment Result
    needs: [semantic-release, deploy-lambda, update-dns]
    if: always()
    uses: ./.github/workflows/notify-telegram.yml
    with:
      deployment_result: ${{ (needs.deploy-lambda.result == 'success' && (needs.update-dns.result == 'success' || needs.update-dns.result == 'skipped')) && 'success' || 'failure' }}
      message: |
        ğŸš€ **ë°°í¬ ê²°ê³¼ ìƒì„¸**
        
        **ğŸ¯ ì‹¤í–‰ ëª¨ë“œ:** ${{ github.event_name == 'workflow_dispatch' && 'ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰' || 'ğŸ”„ ìë™ ë°°í¬' }}
        
        **ğŸ“‹ ê° ë‹¨ê³„ ìƒíƒœ:**
        â€¢ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸: ${{ needs.semantic-release.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
        â€¢ AWS ë°°í¬: ${{ needs.deploy-lambda.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}
        â€¢ DNS ì—…ë°ì´íŠ¸: ${{ needs.update-dns.result == 'success' && 'âœ… ì„±ê³µ' || needs.update-dns.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || needs.update-dns.result == 'failure' && 'âŒ ì‹¤íŒ¨' || 'â¸ï¸ ë¯¸ì‹¤í–‰' }}
        
        **ğŸŒ ë°°í¬ URL:**
        ${{ needs.update-dns.outputs.deployment_url || needs.deploy-lambda.outputs.url || 'âŒ URL ìƒì„± ì‹¤íŒ¨' }}
        
        **ğŸ“Š ìƒì„¸ ì •ë³´:**
        â€¢ ì»¤ë°‹: `${{ github.sha }}`
        â€¢ íŠ¸ë¦¬ê±°: ${{ github.actor }}
        â€¢ ë¸Œëœì¹˜: `${{ github.ref_name }}`
        
        ${{ needs.semantic-release.result == 'success' && 'ğŸ“ **ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**' || '' }}
    secrets:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
