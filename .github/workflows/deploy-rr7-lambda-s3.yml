name: Deploy RR7 to aws lambda & s3

on:
   workflow_call:
      secrets:
         AWS_ACCOUNT_ID:
            description: 'AWS Account ID'
            required: true
         AWS_DEFAULT_REGION:
            description: 'AWS Default Region'
            required: true
      outputs:
         deployment_result:
            description: 'Deployment result output'
            value: ${{ jobs.deploy.outputs.deployment_result }}
         url:
            description: 'Deployment URL'
            value: ${{ jobs.deploy.outputs.url }}
         cname:
            description: 'CNAME for DNS record'
            value: ${{ jobs.deploy.outputs.cname }}
         deployment_message:
            description: 'Deployment summary message for notifications'
            value: ${{ jobs.deploy.outputs.deployment_message }}
         cloudfront_url:
            description: 'CloudFront URL if available'
            value: ${{ jobs.deploy.outputs.cloudfront_url }}
         lambda_url:
            description: 'Lambda URL if available'
            value: ${{ jobs.deploy.outputs.lambda_url }}
   workflow_dispatch:

jobs:
   deploy:
      runs-on: ubuntu-latest
      outputs:
         deployment_result: ${{ steps.deploy.outputs.result }}
         url: ${{ steps.deploy.outputs.url }}
         cname: ${{ steps.deploy.outputs.cname }}
         deployment_message: ${{ steps.deploy.outputs.deployment_message }}
         cloudfront_url: ${{ steps.deploy.outputs.cloudfront_url }}
         lambda_url: ${{ steps.deploy.outputs.lambda_url }}
      steps:
         - name: Checkout repository
           uses: actions/checkout@v4


         - name: Install pnpm
           uses: pnpm/action-setup@v4
           with:
              version: '9.5.0'
              run_install: false

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20.0.0'
              cache: 'pnpm'

         - name: Install dependencies
           run: pnpm i --frozen-lockfile

         - name: Pre-deployment checks
           run: |
              echo "ğŸ” Pre-deployment checks..."
              echo "Current directory: $(pwd)"
              echo "Available packages:"
              find . -name "package.json" -not -path "./node_modules/*" | head -10
              echo "Checking turbo configuration..."
              if [ -f "turbo.json" ]; then
                echo "âœ… turbo.json found"
                grep -A 5 '"deploy"' turbo.json || echo "âš ï¸  No deploy task found in turbo.json"
              else
                echo "âŒ turbo.json not found"
              fi

         - name: Deploy to AWS Lambda
           id: deploy
           env:
              AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
              AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
              CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
              CDK_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
              NODE_ENV: production
           run: |
              echo "ğŸš€ Starting deployment..."
              echo "Environment variables:"
              echo "- AWS_ACCOUNT_ID: ${AWS_ACCOUNT_ID:0:4}****"
              echo "- AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"
              
              # Run deployment with detailed logging
              echo "ğŸ“¦ Running pnpm deploy..."
              set -x
              deployment_output=$(pnpm deploy 2>&1)
              deployment_status=$?
              set +x
              
              echo "ğŸ“‹ Deployment output:"
              echo "$deployment_output"
              
              echo "deployment_output<<EOF" >> $GITHUB_OUTPUT
              echo "$deployment_output" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              
              # Extract URLs from deployment output (CloudFront preferred, Lambda as backup)
              cloudfront_url=$(echo "$deployment_output" | grep -oE 'https://[a-zA-Z0-9]+\.cloudfront\.net[^[:space:]]*' | head -1 || echo "")
              lambda_url=$(echo "$deployment_output" | grep -oE 'https://[a-zA-Z0-9]+\.lambda-url\.[a-zA-Z0-9-]+\.on\.aws[^[:space:]]*' | head -1 || echo "")
              
              # Prefer CloudFront URL, fall back to Lambda URL
              if [[ -n "$cloudfront_url" ]]; then
                deployment_url="$cloudfront_url"
                echo "ğŸŒ CloudFront URL detected: $deployment_url"
              elif [[ -n "$lambda_url" ]]; then
                deployment_url="$lambda_url"
                echo "ğŸŒ Lambda URL detected: $deployment_url"
              else
                # Try to extract any https URL as final fallback
                deployment_url=$(echo "$deployment_output" | grep -oE 'https?://[^[:space:]]+' | head -1 || echo "")
                if [[ -n "$deployment_url" ]]; then
                  echo "ğŸŒ Generic URL detected: $deployment_url"
                else
                  echo "âš ï¸  No deployment URL found in output"
                fi
              fi
              
              echo "url=$deployment_url" >> $GITHUB_OUTPUT
              echo "cloudfront_url=$cloudfront_url" >> $GITHUB_OUTPUT
              echo "lambda_url=$lambda_url" >> $GITHUB_OUTPUT
              
              # Extract CNAME (domain without https://) if URL exists
              if [[ -n "$deployment_url" ]]; then
                cname_value=$(echo "$deployment_url" | sed 's|^https\?://||' | sed 's|/$||')
                echo "cname=$cname_value" >> $GITHUB_OUTPUT
                echo "ğŸ·ï¸  CNAME: $cname_value"
              else
                echo "cname=" >> $GITHUB_OUTPUT
              fi
              
              # Extract deployment time and additional info
              deployment_time=$(echo "$deployment_output" | grep -oE 'Deployment time: [0-9]+\.[0-9]+s' || echo "")
              total_time=$(echo "$deployment_output" | grep -oE 'Total time: [0-9]+\.[0-9]+s' || echo "")
              stack_name=$(echo "$deployment_output" | grep -oE 'nonstop-[a-zA-Z0-9-]+' | head -1 || echo "")
              
              # Set result based on exit status
              if [ $deployment_status -eq 0 ]; then
                echo "result=success" >> $GITHUB_OUTPUT
                echo "âœ… Deployment successful"
                
                # Create deployment message for notifications
                deployment_message="âœ… ë°°í¬ ì„±ê³µ"
                if [[ -n "$deployment_url" ]]; then
                  deployment_message="$deployment_message\nğŸŒ URL: $deployment_url"
                fi
                if [[ -n "$deployment_time" ]]; then
                  deployment_message="$deployment_message\nâ±ï¸ ë°°í¬ ì‹œê°„: $deployment_time"
                fi
                if [[ -n "$total_time" ]]; then
                  deployment_message="$deployment_message\nğŸ“Š ì´ ì‹œê°„: $total_time"
                fi
                echo "deployment_message=$deployment_message" >> $GITHUB_OUTPUT
                
                # Add deployment summary to GitHub Step Summary
                echo "## ğŸš€ ë°°í¬ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
                echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
                echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
                echo "| ë°°í¬ ìƒíƒœ | âœ… ì„±ê³µ |" >> $GITHUB_STEP_SUMMARY
                if [[ -n "$stack_name" ]]; then
                  echo "| ìŠ¤íƒ ì´ë¦„ | \`$stack_name\` |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$deployment_url" ]]; then
                  echo "| ë°°í¬ URL | [$deployment_url]($deployment_url) |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$cloudfront_url" ]]; then
                  echo "| CloudFront URL | [$cloudfront_url]($cloudfront_url) |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$lambda_url" ]]; then
                  echo "| Lambda URL | [$lambda_url]($lambda_url) |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$cname_value" ]]; then
                  echo "| CNAME | \`$cname_value\` |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$deployment_time" ]]; then
                  echo "| ë°°í¬ ì‹œê°„ | $deployment_time |" >> $GITHUB_STEP_SUMMARY
                fi
                if [[ -n "$total_time" ]]; then
                  echo "| ì´ ì‹œê°„ | $total_time |" >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ë°°í¬ ì„¸ë¶€ ì •ë³´" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                echo "Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "result=failed" >> $GITHUB_OUTPUT
                echo "âŒ Deployment failed with exit code: $deployment_status"
                
                # Create failure message for notifications
                deployment_message="âŒ ë°°í¬ ì‹¤íŒ¨\nğŸ” ì¢…ë£Œ ì½”ë“œ: $deployment_status\nğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
                echo "deployment_message=$deployment_message" >> $GITHUB_OUTPUT
                
                # Add failure summary to GitHub Step Summary
                echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
                echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
                echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
                echo "| ë°°í¬ ìƒíƒœ | âŒ ì‹¤íŒ¨ |" >> $GITHUB_STEP_SUMMARY
                echo "| ì¢…ë£Œ ì½”ë“œ | \`$deployment_status\` |" >> $GITHUB_STEP_SUMMARY
                echo "| ë¸Œëœì¹˜ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ğŸ” ë¬¸ì œ í•´ê²° ê°€ì´ë“œ" >> $GITHUB_STEP_SUMMARY
                echo "- AWS ìê²© ì¦ëª… ë° ê¶Œí•œ í™•ì¸" >> $GITHUB_STEP_SUMMARY
                echo "- CDK ë¶€íŠ¸ìŠ¤íŠ¸ë© ì™„ë£Œ ì—¬ë¶€ í™•ì¸" >> $GITHUB_STEP_SUMMARY
                echo "- í•„ìš”í•œ íŒ¨í‚¤ì§€ì˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸" >> $GITHUB_STEP_SUMMARY
                echo "- AWS ê³„ì • ID ë° ë¦¬ì „ ì„¤ì • í™•ì¸" >> $GITHUB_STEP_SUMMARY
                
                echo "ğŸ” Troubleshooting info:"
                echo "- Check AWS credentials and permissions"
                echo "- Verify CDK bootstrap is completed"
                echo "- Check if all required packages have deploy scripts"
                exit $deployment_status
              fi