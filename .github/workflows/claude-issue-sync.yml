name: Claude Code Issue Sync

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  sync-issues:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Check for Claude Code markers
      id: check-markers
      run: |
        # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ Claude Code ë§ˆì»¤ í™•ì¸
        if git log --oneline -1 | grep -q "ğŸ¤– Generated with \[Claude Code\]"; then
          echo "claude-generated=true" >> $GITHUB_OUTPUT
        else
          echo "claude-generated=false" >> $GITHUB_OUTPUT
        fi
        
        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        echo "changed-files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
        
    - name: Update related issues
      if: steps.check-markers.outputs.claude-generated == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Claude Codeì— ì˜í•´ ìƒì„±ëœ ì»¤ë°‹ì¸ ê²½ìš° ê´€ë ¨ ì´ìŠˆ ì—…ë°ì´íŠ¸
        COMMIT_MSG=$(git log --oneline -1)
        CHANGED_FILES="${{ steps.check-markers.outputs.changed-files }}"
        
        # í™œì„± ìƒíƒœì¸ claude-code ë¼ë²¨ì´ ìˆëŠ” ì´ìŠˆ ì°¾ê¸°
        ACTIVE_ISSUES=$(gh issue list --label "claude-code" --state "open" --json number --jq '.[].number')
        
        for issue_num in $ACTIVE_ISSUES; do
          # ê° ì´ìŠˆì— ì§„í–‰ ìƒí™© ì½”ë©˜íŠ¸ ì¶”ê°€
          gh issue comment $issue_num --body "## ğŸ”„ ìë™ ì—…ë°ì´íŠ¸ (GitHub Actions)
        
        **ì»¤ë°‹**: $COMMIT_MSG
        **ë³€ê²½ëœ íŒŒì¼ë“¤**: $CHANGED_FILES
        **ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ì´ ì—…ë°ì´íŠ¸ëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
        done
        
    - name: Auto-close completed issues
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ì™„ë£Œ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì»¤ë°‹ ë©”ì‹œì§€ í™•ì¸
        COMMIT_MSG=$(git log --oneline -1)
        
        if echo "$COMMIT_MSG" | grep -E -i "(ì™„ë£Œ|ì™„ì„±|finish|complete|done|resolve|fix)" > /dev/null; then
          # í™œì„± ìƒíƒœì¸ claude-code ë¼ë²¨ì´ ìˆëŠ” ì´ìŠˆ ì°¾ê¸°
          ACTIVE_ISSUES=$(gh issue list --label "claude-code" --state "open" --json number --jq '.[].number')
          
          for issue_num in $ACTIVE_ISSUES; do
            # ì´ìŠˆ ì™„ë£Œ ì²˜ë¦¬
            gh issue comment $issue_num --body "## âœ… ìë™ ì™„ë£Œ ì²˜ë¦¬
        
        **ì™„ë£Œ ì»¤ë°‹**: $COMMIT_MSG
        **ì™„ë£Œ ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ì»¤ë°‹ ë©”ì‹œì§€ì— ì™„ë£Œ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ì´ìŠˆë¥¼ ì™„ë£Œ ì²˜ë¦¬í•©ë‹ˆë‹¤."
        
            gh issue close $issue_num
            echo "ì´ìŠˆ #$issue_num ì™„ë£Œ ì²˜ë¦¬ë¨"
          done
        fi