#!/bin/bash

# Claude Code Post-Task Hook
# μ‘μ—…μ΄ μ™„λ£λ  λ•λ§λ‹¤ μ‹¤ν–‰λλ” ν›…
# μ‘μ—… κ²°κ³Όλ¥Ό λ¶„μ„ν•μ—¬ GitHub μ΄μλ¥Ό μ—…λ°μ΄νΈν•κ±°λ‚ μ™„λ£ μ²λ¦¬ν•©λ‹λ‹¤.

# ν›… λ””λ ‰ν† λ¦¬ κ²½λ΅
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# μ‘μ—… μ™„λ£ μƒνƒ ν™•μΈ
TASK_STATUS="$1"  # success, error, partial λ“±
TASK_SUMMARY="$2" # μ‘μ—… μ”μ•½

# μΈμκ°€ μ—†μΌλ©΄ λ€ν™”ν•μΌλ΅ μ…λ ¥ λ°›κΈ°
if [ -z "$TASK_STATUS" ]; then
    echo "π¤– Claude Code μ‘μ—… μ™„λ£"
    echo "π“ μ‘μ—… μƒνƒλ¥Ό μ„ νƒν•μ„Έμ”:"
    echo "1) μ™„λ£ (success)"
    echo "2) μ¤λ¥ λ°μƒ (error)"
    echo "3) λ¶€λ¶„ μ™„λ£ (partial)"
    echo "4) μ§„ν–‰ μ¤‘ (progress)"
    read -p "μ„ νƒ (1-4): " choice
    
    case $choice in
        1) TASK_STATUS="success";;
        2) TASK_STATUS="error";;
        3) TASK_STATUS="partial";;
        4) TASK_STATUS="progress";;
        *) TASK_STATUS="unknown";;
    esac
fi

if [ -z "$TASK_SUMMARY" ]; then
    echo "π“‹ μ‘μ—… μ”μ•½μ„ μ…λ ¥ν•μ„Έμ”:"
    read -r TASK_SUMMARY
fi

# ν„μ¬ μ§„ν–‰ μ¤‘μΈ μ΄μκ°€ μλ”μ§€ ν™•μΈ
if [ ! -f "$HOOK_DIR/session-state.json" ]; then
    echo "π’­ μ§„ν–‰ μ¤‘μΈ μ΄μκ°€ μ—†μµλ‹λ‹¤."
    exit 0
fi

# μƒνƒμ— λ”°λ¥Έ μ²λ¦¬
case $TASK_STATUS in
    "success")
        echo "β… μ‘μ—… μ™„λ£ μ²λ¦¬ μ¤‘..."
        
        # Git μƒνƒ ν™•μΈ
        if git status --porcelain | grep -q .; then
            TASK_SUMMARY="$TASK_SUMMARY

### π“ λ³€κ²½λ νμΌλ“¤
\`\`\`
$(git status --porcelain)
\`\`\`"
        fi
        
        # μµκ·Ό μ»¤λ°‹ μ •λ³΄ μ¶”κ°€ (μλ‹¤λ©΄)
        if [ -n "$(git log --oneline -1 --since='1 hour ago' 2>/dev/null)" ]; then
            TASK_SUMMARY="$TASK_SUMMARY

### π“ μµκ·Ό μ»¤λ°‹
\`\`\`
$(git log --oneline -5 --since='1 hour ago')
\`\`\`"
        fi
        
        node "$HOOK_DIR/github-issue-manager.js" complete "$TASK_SUMMARY"
        ;;
        
    "error")
        echo "β μ¤λ¥ λ°μƒ - μ΄μ μ—…λ°μ΄νΈ μ¤‘..."
        
        ERROR_DETAILS="### β μ¤λ¥ λ°μƒ
$TASK_SUMMARY

**μƒνƒ**: μ¤λ¥λ΅ μΈν•΄ μ‘μ—…μ΄ μ¤‘λ‹¨λμ—μµλ‹λ‹¤.
**λ‹¤μ λ‹¨κ³„**: μ¤λ¥λ¥Ό ν•΄κ²°ν• ν›„ μ‘μ—…μ„ μ¬μ‹μ‘ν•΄μ•Ό ν•©λ‹λ‹¤."
        
        node "$HOOK_DIR/github-issue-manager.js" update "$ERROR_DETAILS"
        ;;
        
    "partial")
        echo "β³ λ¶€λ¶„ μ™„λ£ - μ΄μ μ—…λ°μ΄νΈ μ¤‘..."
        
        PARTIAL_DETAILS="### β³ λ¶€λ¶„ μ™„λ£
$TASK_SUMMARY

**μƒνƒ**: μΌλ¶€ μ‘μ—…μ΄ μ™„λ£λμ—μµλ‹λ‹¤.
**λ‹¤μ λ‹¨κ³„**: λ‚¨μ€ μ‘μ—…μ„ κ³„μ† μ§„ν–‰ν•  μμ •μ…λ‹λ‹¤."
        
        node "$HOOK_DIR/github-issue-manager.js" update "$PARTIAL_DETAILS"
        ;;
        
    "progress")
        echo "π”„ μ§„ν–‰ μƒν™© μ—…λ°μ΄νΈ μ¤‘..."
        
        PROGRESS_DETAILS="### π”„ μ§„ν–‰ μƒν™© μ—…λ°μ΄νΈ
$TASK_SUMMARY

**μƒνƒ**: μ‘μ—…μ΄ μ§„ν–‰ μ¤‘μ…λ‹λ‹¤."
        
        node "$HOOK_DIR/github-issue-manager.js" update "$PROGRESS_DETAILS"
        ;;
        
    *)
        echo "β“ μ• μ μ—†λ” μƒνƒ - κΈ°λ³Έ μ—…λ°μ΄νΈ μ¤‘..."
        
        DEFAULT_DETAILS="### π“ μƒνƒ μ—…λ°μ΄νΈ
$TASK_SUMMARY

**μƒνƒ**: μ‘μ—… μƒνƒλ¥Ό ν™•μΈ μ¤‘μ…λ‹λ‹¤."
        
        node "$HOOK_DIR/github-issue-manager.js" update "$DEFAULT_DETAILS"
        ;;
esac

# κ²°κ³Ό μ¶λ ¥
if [ $? -eq 0 ]; then
    echo "β… μ΄μ μ—…λ°μ΄νΈ μ™„λ£"
    echo "π”— GitHubμ—μ„ μ—…λ°μ΄νΈλ λ‚΄μ©μ„ ν™•μΈν•  μ μμµλ‹λ‹¤."
else
    echo "β οΈ  μ΄μ μ—…λ°μ΄νΈμ— μ‹¤ν¨ν–μµλ‹λ‹¤."
fi

echo "π μ‘μ—… μ™„λ£ ν›…μ΄ μ‹¤ν–‰λμ—μµλ‹λ‹¤."